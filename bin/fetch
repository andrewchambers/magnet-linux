#!/bin/sh
set -ue

script_dir=$(dirname "$(readlink -f "$0")")
mirrors="${MAGNET_LINUX_MIRRORS:-$script_dir/../mirrors/current.rec}"
hash="$1"
out="$2"

IFS="
"

for url in $(recsel -e "sha256 = '$hash'" -P url "$mirrors" | shuf)
do
	echo "downloading from mirror $url" 2>&1
	
	curl --insecure -L -o "$out" "$url" || true

	if echo "$hash $out" | sha256sum -c --quiet
	then
		exit 0
	fi
done

echo "no working mirrors for $hash"
exit 1
